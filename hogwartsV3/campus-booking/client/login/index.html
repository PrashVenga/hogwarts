<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hogwarts Login</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="../style.css" />
</head>
<body class="login-page">
  <div class="form-container">
    <h2>Member Login</h2>

    <form id="loginForm">
      <label for="hogwartsId">ðŸ†” Hogwarts ID</label>
      <input type="text" id="hogwartsId" required placeholder="your-hogwarts-id" />

      <label for="password">ðŸ”’ Password</label>
      <input type="password" id="password" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />

      <button type="submit">Enter facility booking</button>
    </form>

    <p>New here? <a href="../register/index.html">Register instead</a></p>
    <div id="loginResult"></div>
  </div>

 <script>
  const API = ''; // same-origin

  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('loginForm');
    const msg  = document.getElementById('loginResult');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      msg.textContent = '';

      const hogwartsId = document.getElementById('hogwartsId').value.trim();
      const password   = document.getElementById('password').value;

      try {
        const res  = await fetch(`${API}/api/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include', // <-- include cookies if server uses sessions
          body: JSON.stringify({ hogwartsId, password })
        });
        const data = await res.json();

        // Normalize server shapes:
        const ok    = res.ok && (data.ok === true || data.success === true);
        const role  = data.role ?? data.user?.role;
        const id    = data.id   ?? data.user?.id;
        const hid   = data.hogwartsId ?? data.user?.hogwartsId ?? hogwartsId;

        if (!ok || !role) throw new Error(data.error || 'Login failed');

        // Persist for later pages
        if (id) localStorage.setItem('userId', String(id));
        localStorage.setItem('hogwartsId', hid);
        localStorage.setItem('role', role);

        // Redirect: teacher/admin -> teacher page; others -> booking
        if (role === 'teacher' || role === 'admin') {
          window.location.href = '../teacher/index.html';   // <-- updated
        } else {
          window.location.href = '../booking/index.html';
        }
      } catch (err) {
        msg.style.color = '#ff9999';
        msg.textContent = `âŒ ${err.message || 'Network errorâ€”please try again.'}`;
      }
    });
  });
</script>
</body>
</html>
